/* eslint-disable */
import axios from 'axios'
import qs from 'qs'

export default class Requester {
  constructor($domain) {
    if ($domain) {
      this.domain = $domain
    }
  }
  domain = ''
  axios = null
  headers = {}
  static commonAxiosInstance = null
  static initAxios(config = {}) {
    this.commonAxiosInstance = axios.create(config)
    return this.commonAxiosInstance
  }
  setDomain($domain) {
    this.domain = $domain
  }
  setHeaders(headers = {}, replace = false) {
    if (replace) {
      this.headers = headers;
    } else {
      this.headers = {
        ...this.headers,
        ...headers,
      }
    }
  }
  setAxios($axios) {
    this.axios = $axios
  }
  checkAxios() {
    if (!this.axios) {
      if (!Requester.commonAxiosInstance) {
        Requester.initAxios()
      }
      this.axios = Requester.commonAxiosInstance
    }
  }

  request(requestParams) {
    this.checkAxios();
    const {
      method = 'get',
      host = this.domain,
      path,
      query = {},
      body = {},
      config = {
        headers: this.headers,
      },
    } = requestParams
    let requestMethod = method.toLowerCase()
    if (!['get', 'post', 'put', 'delete', 'head', 'option', 'patch'].includes(requestMethod.toLowerCase())) {
      return Promise.reject(new Error('Not supported request method: ' + requestMethod))
    }
    let requestUrl = host + path
    let urlParams = qs.stringify(query)
    if (requestMethod === 'get') {
      urlParams = qs.stringify({
        ...query,
        ...body,
      })
    }
    if (urlParams) {
      if (requestUrl.indexOf('?') < 0) {
        requestUrl = '?' + urlParams
      } else if (!requestUrl.endsWith('?')) {
        requestUrl = '&' + urlParams
      }
    }
    const resuestConfig = {
      ...config,
      headers: {
        ...this.headers,
        ...(config.headers || {})
      }
    }
    if (requestMethod === 'delete') {
      return this.axios[requestMethod](requestUrl, {
        ...resuestConfig,
        data: body || {}
      })
    }
    if (requestMethod === 'post' || requestMethod === 'put' || requestMethod === 'patch') {
      return this.axios[requestMethod](requestUrl, body, resuestConfig)
    }
    // requestMethod === 'get' || requestMethod === 'head' || requestMethod === 'option'
    return this.axios[requestMethod](requestUrl, resuestConfig)
  }
}
